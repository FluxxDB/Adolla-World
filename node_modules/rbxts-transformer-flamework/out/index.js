"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var transformFile_1 = require("./transformations/transformFile");
var transformState_1 = require("./classes/transformState");
var logger_1 = require("./classes/logger");
var viewFile_1 = require("./information/viewFile");
var factory_1 = require("./util/factory");
function default_1(program, config) {
    return function (context) {
        logger_1.Logger.write("\n");
        factory_1.f.setFactory(context.factory);
        var state = new transformState_1.TransformState(program, context, config !== null && config !== void 0 ? config : {});
        var hasCollectedInformation = false;
        return function (file) {
            if (!hasCollectedInformation) {
                hasCollectedInformation = true;
                state.symbolProvider.registerInterestingFiles();
                program.getSourceFiles().forEach(function (file) {
                    if (file.isDeclarationFile && !state.shouldViewFile(file))
                        return;
                    viewFile_1.viewFile(state, file);
                });
                state.setupMacros();
            }
            if (state.hasErrors)
                return file;
            var result = transformFile_1.transformFile(state, file);
            return result;
        };
    };
}
exports.default = default_1;
